{% extends "base.html" %}

{% block title %}ListView{% endblock  %}

{% block script %}
$( document ).ready(function() {
    console.log("working");
    var tweets_list = [];
    var query = getParameterByName('q');

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function attach_tweet(tweetvalue, prepend){
        var tweet_user = tweetvalue.user.username;
        var tweet_content = tweetvalue.content;
        var tweet_date_display = tweetvalue.date_display;
        var tweet_timesince = tweetvalue.timesince;
        var tweet_formattedhtml = "<div class='media'><div class='media-body'>" + tweet_content + "<br> via : " + tweet_user + " | " + tweet_date_display +  " | " + tweet_timesince + "<a href='#'> View </a></div></div><hr/>";
        
        if (prepend == true){

            $('#tweet-container').prepend(tweet_formattedhtml);
        }else{
            $('#tweet-container').append(tweet_formattedhtml);
        }
    }

    function parseTweets(){
        if (tweets_list == 0){
             $('#tweet-container').text("No Tweet currently found");
        }else{
            $.each( tweets_list, function( key, value ) {
                attach_tweet(value , false)
            });
        }
    }

    function fetchTweets(){
        $.ajax({
            url: '/api/tweets/',
            data:{'q':query},
            success: function(data , textStatus ,jqXHR){
                tweets_list = data;
                parseTweets();
            },
            error: function(jqXHR, textStatus, errorThrown){
                console.log(textStatus)
                console.log(errorThrown)
            }
        });
    }

    fetchTweets()

    // this is the id of the form
    $("#create_form").submit(function(e) {

        e.preventDefault(); // avoid to execute the actual submit of the form.
        console.log("Create")

        var form = $(this);
        var url = form.attr('action');
        var this_ = $(this)

        $.ajax({
            type: "POST",
            url: '/api/tweets/create/',
            data: form.serialize(), // serializes the form's elements.
            success: function(data)
            {
                this_.find('input[type=text],textarea').val('')
                attach_tweet(data , true)
            }
            }); 

    });

});

{% endblock script %}

{% block content %}

<br>

<div class="row">
    <div class="col-sm-8 col-sm-offset-2">

{% if not request.GET.q %}
    <div class="">
        {% include "tweets/form.html" with form=create_form action_url=create_url btn_title='Tweet' form_id='create_form' %}
    </div>
{% endif %}

<div id="tweet-container">
</div>
{% comment %} 
{% for obj in object_list %}
        <div class="media">
            <div class="media-left">
                <a href="#">
                {% if obj.img %}
                    <img src="img_avatar1.png" class="media-object" style="width:60px">
                {% endif %}
                </a>
            </div>
            <div class="media-body">
                {{ obj.content }} | <br>
                via : {{ obj.user }} | {{ obj.timestamp|timesince }} ago <a href="{{ obj.get_absolute_url }}">View</a>
            </div>
        </div>
        <hr/>
        {% empty %}
            {% if request.GET.q %}
                <p>No Tweet Found </p>
            {% else %}
                <p>EMPTY FORM</p>
            {% endif %}
{% endfor %} {% endcomment %}

    </div>
</div>

{% endblock content %}
