{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">

    <title>{% block title %}Tweetme : {% endblock  %}</title>
  </head>
  <body>
    {% include "navbar.html" %}
    <div class="container">
    {% block content %}
    
    {% endblock %}
    </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="{% static 'bootstrap/js/jquery-3.4.1.min.js' %}"></script>
    <script>
    function loadTweetContainer(tweetContainerID){
    console.log("working");
    var tweets_list = [];
    var query = getParameterByName('q');
    var tweetContainer;
    tweetContainer = $('#' + tweetContainerID )
    var APIUrl=tweetContainer.attr("data-url") || "/api/tweets/";

    function updateHashLinks(){
        $(".media-body").each(function(data){
            var hashtagRegx = /(^|\s)#([\w\d-]+)/g
            var usernameRegx = /(^|\s)@([\w\d-]+)/g
            var newText;
            newText = $(this).html().replace(hashtagRegx, "$1<a href='/tags/$2/'>#$2</a>")
            newText = newText.replace(usernameRegx, "$1<a href='/$2/'>@$2</a>")
            $(this).html(newText)
        })
    }

    // get q parameter in url _ GET method
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function attach_tweet(tweetvalue, prepend, retweet_flag){
        var tweet_user = tweetvalue.user.username;
        var tweet_content = tweetvalue.content;
        var tweet_date_display = tweetvalue.date_display;
        var tweet_timesince = tweetvalue.timesince;
        var tweet_link = "/tweets/" + tweetvalue.id;
        var profile_url = tweetvalue.user.profile_url;
        var tweet_formattedhtml;
        var retweet_link = "/api/tweets/retweet/" + tweetvalue.id
        if (retweet_flag && tweetvalue.parent){
            var mainTweet = tweetvalue.parent
            tweet_formattedhtml = "<div class='media'><div class='media-body'><span style='color:#276090;'>Retweet Via <a href='/" + mainTweet.user.username + "/'>" + mainTweet.user.username + "</a> On " + mainTweet.date_display + "</span><br>" + tweet_content + "<br> via : " + "<a href='" + profile_url + "'>" + tweet_user + "</a>" + " | " + tweet_date_display +  " | " + tweet_timesince + "<a href=" + tweet_link + "> View </a> | <a class='retweet' href='" + retweet_link + "'>Retweet</a></div></div><hr/>";
        }else{
            tweet_formattedhtml = "<div class='media'><div class='media-body'>" + tweet_content + "<br> via : " + "<a href='" + profile_url + "'>" + tweet_user + "</a>" + " | " + tweet_date_display +  " | " + tweet_timesince + "<a href=" + tweet_link + "> View </a> | <a class='retweet' href='" + retweet_link + "'>Retweet</a></div></div><hr/>";
        }
        
        
        // if prepen is true add to above of list        
        if (prepend == true){
            tweetContainer.prepend(tweet_formattedhtml);
        }else{
            tweetContainer.append(tweet_formattedhtml);
        }
    }

    function parseTweets(){
        if (tweets_list == 0){
             tweetContainer.text("No Tweet currently found");
        }else{
            $.each( tweets_list, function( key, value ) {
                if (value.parent){
                    attach_tweet(value , false, true)
                }else{
                    attach_tweet(value , false)
                }
            });
        }
    }

    var next_url;
    var fetch_url;

    function fetchTweets(url){
        if (next_url){
            fetch_url = next_url;
        }else{
            fetch_url = APIUrl;
        }
        $.ajax({
            url: fetch_url,
            data:{'q':query},
            success: function(data , textStatus ,jqXHR){
                tweets_list = data.results;
                next_url = data.next;
                if (!next_url){
                    $("#loadmore").css('display','none')
                }
                parseTweets();
                updateHashLinks();
            },
            error: function(jqXHR, textStatus, errorThrown){
                console.log(textStatus)
                console.log(errorThrown)
            }
        });
    }

    fetchTweets()

    var character_counter = 140; 
    var char_count = 0;
    $("#create_form").append("<span id='tweet_character_counter'> &nbsp; " + character_counter + "</span>")
    var txt_character_counter = $("#tweet_character_counter");

    $("#create_form textarea").keyup(function( event ) {
        char_count = $(this).val().length;
        character_counter = 140 - char_count;
        txt_character_counter.text("\xa0" + character_counter);
        if (character_counter > 0){txt_character_counter.css("color", "#000");}
        else if(character_counter == 0){txt_character_counter.css("color", "#ccc");}
        else if(character_counter < 0){txt_character_counter.css("color", "red");}
    });

    $("#create_form").submit(function(e) {
        e.preventDefault(); // avoid to execute the actual submit of the form.

        var form = $(this);
        var url = form.attr('action');
        var this_ = $(this)

        if (character_counter < 0 ){
            console.log("Cannot Create")
        }else{
            $.ajax({
                type: "POST",
                url: '/api/tweets/create/',
                data: form.serialize(), // serializes the form's elements.
                success: function(data)
                {
                    this_.find('input[type=text],textarea').val('')
                    attach_tweet(data , true)
                    updateHashLinks();
                }
            }); 
        }
        
    });

    $("#loadmore").click(function(){
        if (next_url){
            fetchTweets(next_url)
        }
    });

    $(document).on('click', ".retweet", function(e) {        
        e.preventDefault()
        retweet_html =  $(this)
        url = retweet_html.attr("href")
        $.ajax({
            url: url,
            success: function(data)
            {
                attach_tweet(data , true, true)
            },
            error: function(data, textStatus, errorThrown){
                alert(data.responseJSON.message)
            }
        }); 
    });
}
    </script>

    <script>{% block script %}{% endblock script %}</script>
    <script>
    $( document ).ready(function() {

        var typingtimer;
        var search_query;
        var search_input = $("#form_search input[type='text'");

        search_input.keyup(function( event ) {
          search_query = $(this).val()
          console.log("up")
          clearTimeout(typingtimer)
          typingtimer = setTimeout(doneSearchTyping, 800)

        });

        search_input.keydown(function( event ) {
          console.log("down")
          clearTimeout(typingtimer)

        });

        function doneSearchTyping(){ 
            if(search_query){
              var url = '/tweets/search/?q=' + search_query;
              document.location.href = url;
            }
        }
    });

    </script>
    <script src="{% static 'bootstrap/js/bootstrap.min.js' %}"></script>
  </body>
</html>